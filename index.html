<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í—ˆê·¸í• ê´€ë¦¬ì ì¶œì„í˜ì´ì§€</title>
  <style>
    body { font-family: 'Arial'; padding: 20px; background: #f6f8fa; }
    h2 { text-align: center; color: #333; }
    label, select, input { font-size: 16px; margin: 10px 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th { background-color: #f0f0f0; }
    .filter-area { margin-bottom: 20px; text-align: center; }
    .status { 
      padding: 5px 10px; 
      border-radius: 3px; 
      font-size: 12px; 
      font-weight: bold; 
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .loading { background: #d1ecf1; color: #0c5460; }
    .info { background: #d1ecf1; color: #0c5460; }
    button { 
      padding: 8px 16px; 
      margin: 5px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px; 
    }
    button:hover { opacity: 0.8; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-danger { background: #dc3545; color: white; }
    #statusMessage { margin: 10px 0; padding: 10px; border-radius: 4px; }
    .data-management { 
      margin: 20px 0; 
      padding: 15px; 
      background: #e9ecef; 
      border-radius: 5px; 
    }
    textarea { 
      width: 100%; 
      height: 100px; 
      margin: 10px 0; 
      padding: 10px; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
    }
    .export-import { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      justify-content: center; 
      flex-wrap: wrap; 
    }
    .github-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }
    .github-info h3 {
      margin-top: 0;
      color: #495057;
    }
    .github-info p {
      margin: 10px 0;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <h2>í—ˆê·¸í• ê´€ë¦¬ì ì¶œì„ í˜ì´ì§€</h2>

  <div class="github-info">
    <h3>ğŸš€ GitHub Pages ë°°í¬ìš© ë²„ì „</h3>
    <p>ì´ í˜ì´ì§€ëŠ” GitHub Pagesì—ì„œ í˜¸ìŠ¤íŒ…ë  ìˆ˜ ìˆìœ¼ë©°, ë°ì´í„°ëŠ” JSON íŒŒì¼ë¡œ ë°±ì—…/ë³µì›ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
    <p>ì—¬ëŸ¬ ì»´í“¨í„°ì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ ë°ì´í„°ë¥¼ ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ê¸°ëŠ¥ì„ í™œìš©í•˜ì„¸ìš”.</p>
  </div>

  <div id="statusMessage" style="display: none;"></div>

  <div class="filter-area">
    <label for="search">ê³ ê° ì´ë¦„ ê²€ìƒ‰:</label>
    <input type="text" id="search" placeholder="ì˜ˆ: ê¹€ë¯¼ì •">
    <button class="btn-info" onclick="searchMember()">ê²€ìƒ‰</button>

    <br><br>
    <label>ë“±ë¡ ìœ í˜•:</label>
    <select id="regType" onchange="toggleOptions()">
      <option value="ì¿ í°">ì¿ í°</option>
      <option value="ê¸°ê°„">ê¸°ê°„</option>
    </select>

    <span id="couponOptions">
      <select id="couponSelect">
        <option value="10íšŒ_1ê°œì›”">í•œë‹¬ 10íšŒ</option>
        <option value="30íšŒ_3ê°œì›”">30íšŒ 3ê°œì›”</option>
      </select>
    </span>

    <span id="periodOptions" style="display: none;">
      <select id="periodSelect">
        <option value="1ê°œì›”">1ê°œì›”</option>
        <option value="3ê°œì›”">3ê°œì›”</option>
      </select>
    </span>

    <button class="btn-primary" onclick="registerCustomer()">ê³ ê° ë“±ë¡</button>
    <button class="btn-success" onclick="markVisit()">ì¶œì„ ì²˜ë¦¬</button>
    <button class="btn-info" onclick="loadAllMembers()">ì „ì²´ íšŒì› ì¡°íšŒ</button>
  </div>

  <div class="data-management">
    <h3>ë°ì´í„° ê´€ë¦¬</h3>
    <div class="export-import">
      <button class="btn-warning" onclick="exportData()">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn-info" onclick="importData()">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
      <button class="btn-danger" onclick="clearAllData()" style="margin-left: 20px;">ì „ì²´ ë°ì´í„° ì‚­ì œ</button>
    </div>
    <textarea id="dataTextarea" placeholder="ì—¬ê¸°ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê¸°í•˜ê±°ë‚˜, ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
  </div>

  <table>
    <thead>
      <tr>
        <th>ê³ ê°ëª…</th>
        <th>ë“±ë¡ì¼ì</th>
        <th>ìµœê·¼ë°©ë¬¸ì¼</th>
        <th>ë‚¨ì€íšŸìˆ˜/ê¸°ê°„</th>
        <th>ìƒíƒœ</th>
        <th>ê´€ë¦¬</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>

  <script>
    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    function toggleOptions() {
      const type = document.getElementById("regType").value;
      document.getElementById("couponOptions").style.display = type === 'ì¿ í°' ? 'inline' : 'none';
      document.getElementById("periodOptions").style.display = type === 'ê¸°ê°„' ? 'inline' : 'none';
    }

    function registerCustomer() {
      const name = prompt("ë“±ë¡í•  ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
      if (!name) return;
      
      // ì¤‘ë³µ í™•ì¸
      const key = `member_${name}`;
      if (localStorage.getItem(key)) {
        if (!confirm(`${name} ê³ ê°ì´ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
        }
      }
      
      showStatus("ê³ ê° ë“±ë¡ ì¤‘...", "loading");
      
      const now = new Date();
      const regType = document.getElementById("regType").value;

      let info = {
        name: name,
        regDate: now.toISOString().split('T')[0],
        lastVisit: '',
        type: regType,
        registeredAt: now.toISOString() // ë“±ë¡ ì‹œì  ì¶”ê°€
      };

      if (regType === 'ì¿ í°') {
        const val = document.getElementById("couponSelect").value;
        const count = parseInt(val.split("íšŒ")[0]);
        info.count = count;
        info.originalCount = count; // ì›ë˜ íšŸìˆ˜ ì €ì¥
      } else {
        const period = document.getElementById("periodSelect").value;
        const days = parseInt(period.replace("ê°œì›”", '')) * 30;
        const expireDate = new Date(now.getTime() + days * 24*60*60*1000);
        info.expire = expireDate.toISOString().split('T')[0];
      }

      try {
        localStorage.setItem(key, JSON.stringify(info));
        showStatus(`${name} ê³ ê° ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
        
        // ê²€ìƒ‰ í•„ë“œì— ë“±ë¡í•œ ê³ ê°ëª… ì…ë ¥í•˜ê³  ìë™ ê²€ìƒ‰
        document.getElementById("search").value = name;
        setTimeout(() => searchMember(), 500);
        
      } catch (error) {
        console.error('ë“±ë¡ ì‹¤íŒ¨:', error);
        showStatus("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
      }
    }

    function searchMember() {
      const name = document.getElementById("search").value.trim();
      const tbody = document.getElementById("resultBody");
      tbody.innerHTML = '';

      if (!name) {
        showStatus("ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
        return;
      }

      const key = `member_${name}`;
      const data = localStorage.getItem(key);
      
      if (!data) {
        showStatus("ë“±ë¡ëœ ê³ ê° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", "warning");
        return;
      }

      const info = JSON.parse(data);
      displayMemberRow(info);
    }

    function displayMemberRow(info) {
      const tbody = document.getElementById("resultBody");
      const row = document.createElement("tr");
      
      // ë§Œë£Œ ì—¬ë¶€ í™•ì¸
      let statusText = '';
      let statusClass = '';
      
      if (info.type === 'ì¿ í°') {
        statusText = info.count > 0 ? `${info.count}íšŒ ë‚¨ìŒ` : 'ì‚¬ìš©ì™„ë£Œ';
        statusClass = info.count > 0 ? 'success' : 'error';
      } else {
        const today = new Date();
        const expireDate = new Date(info.expire);
        const daysLeft = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysLeft > 0) {
          statusText = `${daysLeft}ì¼ ë‚¨ìŒ`;
          statusClass = daysLeft > 7 ? 'success' : 'warning';
        } else {
          statusText = 'ê¸°ê°„ë§Œë£Œ';
          statusClass = 'error';
        }
      }
      
      row.innerHTML = `
        <td>${info.name}</td>
        <td>${info.regDate}</td>
        <td>${info.lastVisit || '-'}</td>
        <td>${info.type === 'ì¿ í°' ? `${info.count}íšŒ` : `~ ${info.expire}`}</td>
        <td><span class="status ${statusClass}">${statusText}</span></td>
        <td>
          <button class="btn-danger" onclick="deleteMember('${info.name}')" style="font-size: 12px; padding: 4px 8px;">ì‚­ì œ</button>
        </td>
      `;
      tbody.appendChild(row);
    }

    function markVisit() {
      const name = document.getElementById("search").value.trim();
      if (!name) {
        showStatus("ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
        return;
      }

      const key = `member_${name}`;
      const data = localStorage.getItem(key);
      if (!data) {
        showStatus("ë“±ë¡ëœ ê³ ê° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", "warning");
        return;
      }

      const info = JSON.parse(data);
      
      // ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
      if (info.type === 'ì¿ í°' && info.count <= 0) {
        showStatus("ë‚¨ì€ íšŸìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
        return;
      }
      
      if (info.type === 'ê¸°ê°„') {
        const today = new Date();
        const expireDate = new Date(info.expire);
        if (today > expireDate) {
          showStatus("ì´ìš© ê¸°ê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "error");
          return;
        }
      }

      showStatus("ì¶œì„ ì²˜ë¦¬ ì¤‘...", "loading");
      
      const today = new Date().toISOString().split('T')[0];
      info.lastVisit = today;

      if (info.type === 'ì¿ í°') {
        if (info.count > 0) info.count--;
      }

      try {
        localStorage.setItem(key, JSON.stringify(info));
        showStatus(`${name} ê³ ê°ì˜ ì¶œì„ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
        
        // ìë™ìœ¼ë¡œ ê²€ìƒ‰ ê²°ê³¼ ê°±ì‹ 
        setTimeout(() => searchMember(), 500);
        
      } catch (error) {
        console.error('ì¶œì„ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        showStatus("ì¶œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
      }
    }

    function loadAllMembers() {
      const tbody = document.getElementById("resultBody");
      tbody.innerHTML = '';
      
      let hasMembers = false;
      const members = [];
      
      // localStorageì—ì„œ ëª¨ë“  íšŒì› ì •ë³´ ë¡œë“œ
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('member_')) {
          const data = localStorage.getItem(key);
          if (data) {
            const info = JSON.parse(data);
            members.push(info);
            hasMembers = true;
          }
        }
      }
      
      // ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬
      members.sort((a, b) => a.name.localeCompare(b.name));
      
      // í™”ë©´ì— í‘œì‹œ
      members.forEach(info => displayMemberRow(info));
      
      if (!hasMembers) {
        showStatus("ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.", "warning");
      } else {
        showStatus(`ì´ ${members.length}ëª…ì˜ íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, "success");
      }
    }

    function deleteMember(name) {
      if (!confirm(`${name} ê³ ê° ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      const key = `member_${name}`;
      localStorage.removeItem(key);
      showStatus(`${name} ê³ ê° ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
      
      // í˜„ì¬ ê²€ìƒ‰ëœ ê³ ê°ì´ ì‚­ì œëœ ê²½ìš° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      if (document.getElementById("search").value.trim() === name) {
        document.getElementById("search").value = '';
        document.getElementById("resultBody").innerHTML = '';
      } else {
        loadAllMembers();
      }
    }

    function exportData() {
      const members = [];
      
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('member_')) {
          const data = localStorage.getItem(key);
          if (data) {
            members.push(JSON.parse(data));
          }
        }
      }
      
      if (members.length === 0) {
        showStatus("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "warning");
        return;
      }
      
      const exportData = {
        exportDate: new Date().toISOString(),
        version: "1.0",
        members: members
      };
      
      const jsonString = JSON.stringify(exportData, null, 2);
      document.getElementById('dataTextarea').value = jsonString;
      
      // í´ë¦½ë³´ë“œì— ë³µì‚¬
      navigator.clipboard.writeText(jsonString).then(() => {
        showStatus(`${members.length}ëª…ì˜ ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤. (í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨)`, "success");
      }).catch(() => {
        showStatus(`${members.length}ëª…ì˜ ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, "success");
      });
    }

    function importData() {
      const jsonData = document.getElementById('dataTextarea').value.trim();
      
      if (!jsonData) {
        showStatus("ê°€ì ¸ì˜¬ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
        return;
      }
      
      try {
        const data = JSON.parse(jsonData);
        
        if (!data.members || !Array.isArray(data.members)) {
          throw new Error("ì˜¬ë°”ë¥¸ ë°ì´í„° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
        }
        
        let importCount = 0;
        let skipCount = 0;
        
        data.members.forEach(member => {
          const key = `member_${member.name}`;
          
          if (localStorage.getItem(key)) {
            skipCount++;
          } else {
            localStorage.setItem(key, JSON.stringify(member));
            importCount++;
          }
        });
        
        showStatus(`ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ${importCount}ëª… ì¶”ê°€, ${skipCount}ëª… ì¤‘ë³µ ê±´ë„ˆëœ€`, "success");
        document.getElementById('dataTextarea').value = '';
        
      } catch (error) {
        console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        showStatus("ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", "error");
      }
    }

    function clearAllData() {
      if (!confirm("ëª¨ë“  íšŒì› ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
        return;
      }
      
      if (!confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        return;
      }
      
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('member_')) {
          keys.push(key);
        }
      }
      
      keys.forEach(key => localStorage.removeItem(key));
      
      document.getElementById("resultBody").innerHTML = '';
      document.getElementById("search").value = '';
      
      showStatus(`${keys.length}ëª…ì˜ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = function() {
      showStatus("í—ˆê·¸í• ê´€ë¦¬ì í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
      
      // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê³µìœ  ê¸°ëŠ¥)
      const urlParams = new URLSearchParams(window.location.search);
      const sharedData = urlParams.get('data');
      if (sharedData) {
        try {
          document.getElementById('dataTextarea').value = decodeURIComponent(sharedData);
          showStatus("ê³µìœ ëœ ë°ì´í„°ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. 'ë°ì´í„° ê°€ì ¸ì˜¤ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.", "info");
        } catch (e) {
          console.error('ê³µìœ  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        }
      }
    };

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', function(e) {
      // Ctrl+Enter: ì¶œì„ ì²˜ë¦¬
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        markVisit();
      }
      // Ctrl+N: ê³ ê° ë“±ë¡
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        registerCustomer();
      }
    });

    // ê²€ìƒ‰ì°½ì—ì„œ Enter í‚¤ ì²˜ë¦¬
    document.getElementById('search').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchMember();
      }
    });
  </script>
</body>
</html>