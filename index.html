<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>허그핏 관리자 출석페이지</title>
  <style>
    body { font-family: 'Arial'; padding: 20px; background: #f6f8fa; }
    h2 { text-align: center; color: #333; }
    label, select, input { font-size: 16px; margin: 10px 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th { background-color: #f0f0f0; }
    .filter-area { margin-bottom: 20px; text-align: center; }
    .status { 
      padding: 5px 10px; 
      border-radius: 3px; 
      font-size: 12px; 
      font-weight: bold; 
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .loading { background: #d1ecf1; color: #0c5460; }
    .info { background: #d1ecf1; color: #0c5460; }
    button { 
      padding: 8px 16px; 
      margin: 5px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px; 
    }
    button:hover { opacity: 0.8; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-danger { background: #dc3545; color: white; }
    #statusMessage { margin: 10px 0; padding: 10px; border-radius: 4px; }
    .google-sheets-info { 
      margin: 20px 0; 
      padding: 15px; 
      background: #e7f3ff; 
      border-radius: 5px; 
      border-left: 4px solid #007bff;
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .sync-status {
      text-align: center;
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>허그핏 관리자 출석 페이지</h2>

  <div class="google-sheets-info">
    <h3>📊 구글 스프레드시트 연동 버전</h3>
    <p>모든 데이터는 구글 스프레드시트에 실시간으로 저장되며, 여러 기기에서 동시에 사용할 수 있습니다.</p>
    <p><strong>마지막 동기화:</strong> <span id="lastSync">-</span></p>
    <button class="btn-info" onclick="refreshData()">🔄 데이터 새로고침</button>
  </div>

  <div id="statusMessage" style="display: none;"></div>

  <div class="filter-area">
    <label for="search">고객 이름 검색:</label>
    <input type="text" id="search" placeholder="예: 김민정">
    <button class="btn-info" onclick="searchMember()">검색</button>

    <br><br>
    <label>등록 유형:</label>
    <select id="regType" onchange="toggleOptions()">
      <option value="쿠폰">쿠폰</option>
      <option value="기간">기간</option>
    </select>

    <span id="couponOptions">
      <select id="couponSelect">
        <option value="10회_1개월">한달 10회</option>
        <option value="30회_3개월">30회 3개월</option>
        <option value="custom">직접입력</option>
      </select>
      <input type="number" id="customCount" placeholder="횟수" style="display: none; width: 80px;">
    </span>

    <span id="periodOptions" style="display: none;">
      <select id="periodSelect">
        <option value="1개월">1개월</option>
        <option value="3개월">3개월</option>
        <option value="6개월">6개월</option>
        <option value="custom">직접입력</option>
      </select>
      <input type="number" id="customPeriod" placeholder="개월" style="display: none; width: 80px;">
    </span>

    <button class="btn-primary" onclick="registerCustomer()" id="registerBtn">고객 등록</button>
    <button class="btn-success" onclick="markVisit()" id="visitBtn">출석 처리</button>
    <button class="btn-info" onclick="loadAllMembers()" id="loadAllBtn">전체 회원 조회</button>
    <button class="btn-success" onclick="loadTodayVisitors()" id="todayBtn">오늘 출석자</button>
  </div>

  <div class="sync-status" id="syncStatus" style="display: none;"></div>

  <table>
    <thead>
      <tr>
        <th>고객명</th>
        <th>등록일자</th>
        <th>최근방문일</th>
        <th>남은횟수/기간</th>
        <th>상태</th>
        <th>관리</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>

  <script>
    // API URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbw3UXzSQbI6jIIVEbUYMCaHKQS4izqki9kJXO5oOORcKyid6tpofsFKtsE9K433IN2Ulw/exec';
    
    // 상태 메시지 표시 함수
    function showStatus(message, type = 'info', showSpinner = false) {
      const statusDiv = document.getElementById('statusMessage');
      const spinnerHtml = showSpinner ? '<div class="loading-spinner"></div>' : '';
      statusDiv.innerHTML = spinnerHtml + message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      if (!showSpinner) {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }

    // 동기화 상태 표시
    function showSyncStatus(message, type = 'info') {
      const syncDiv = document.getElementById('syncStatus');
      syncDiv.textContent = message;
      syncDiv.className = `sync-status ${type}`;
      syncDiv.style.display = 'block';
      
      setTimeout(() => {
        syncDiv.style.display = 'none';
      }, 2000);
    }

    // 마지막 동기화 시간 업데이트
    function updateLastSync() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('ko-KR');
      document.getElementById('lastSync').textContent = timeString;
    }

    // API 호출 함수
    async function callAPI(action, data = {}) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: action,
          ...data
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      return await response.json();
    }

    // 버튼 상태 제어
    function setButtonsEnabled(enabled) {
      const buttons = ['registerBtn', 'visitBtn', 'loadAllBtn', 'todayBtn'];
      buttons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.disabled = !enabled;
        }
      });
    }

    function toggleOptions() {
      const type = document.getElementById("regType").value;
      document.getElementById("couponOptions").style.display = type === '쿠폰' ? 'inline' : 'none';
      document.getElementById("periodOptions").style.display = type === '기간' ? 'inline' : 'none';
      
      // 커스텀 입력 필드 토글
      toggleCustomInput();
    }

    function toggleCustomInput() {
      const regType = document.getElementById("regType").value;
      
      if (regType === '쿠폰') {
        const couponValue = document.getElementById("couponSelect").value;
        document.getElementById("customCount").style.display = couponValue === 'custom' ? 'inline' : 'none';
      } else {
        const periodValue = document.getElementById("periodSelect").value;
        document.getElementById("customPeriod").style.display = periodValue === 'custom' ? 'inline' : 'none';
      }
    }

    // 이벤트 리스너 등록
    document.getElementById("couponSelect").addEventListener("change", toggleCustomInput);
    document.getElementById("periodSelect").addEventListener("change", toggleCustomInput);

    async function registerCustomer() {
      const name = prompt("등록할 고객명을 입력해주세요:");
      if (!name || !name.trim()) return;
      
      const trimmedName = name.trim();
      
      setButtonsEnabled(false);
      showStatus("고객 등록 중...", "loading", true);
      
      try {
        const regType = document.getElementById("regType").value;
        let memberData = {
          name: trimmedName,
          type: regType
        };

        if (regType === '쿠폰') {
          const couponValue = document.getElementById("couponSelect").value;
          let count;
          
          if (couponValue === 'custom') {
            count = parseInt(document.getElementById("customCount").value);
            if (!count || count <= 0) {
              showStatus("올바른 횟수를 입력해주세요.", "warning");
              return;
            }
          } else {
            count = parseInt(couponValue.split("회")[0]);
          }
          
          memberData.count = count;
        } else {
          const periodValue = document.getElementById("periodSelect").value;
          let months;
          
          if (periodValue === 'custom') {
            months = parseInt(document.getElementById("customPeriod").value);
            if (!months || months <= 0) {
              showStatus("올바른 기간을 입력해주세요.", "warning");
              return;
            }
          } else {
            months = parseInt(periodValue.replace("개월", ''));
          }
          
          memberData.months = months;
        }

        const result = await callAPI('registerMember', memberData);
        
        if (result.success) {
          showStatus(`${trimmedName} 고객 등록이 완료되었습니다.`, "success");
          showSyncStatus("✅ 구글 시트에 저장됨", "success");
          updateLastSync();
          
          // 등록 후 자동 검색
          document.getElementById("search").value = trimmedName;
          setTimeout(() => searchMember(), 500);
        } else {
          showStatus(`등록 실패: ${result.error || '알 수 없는 오류'}`, "error");
        }
        
      } catch (error) {
        console.error('등록 실패:', error);
        showStatus("서버 연결 오류가 발생했습니다.", "error");
      } finally {
        setButtonsEnabled(true);
      }
    }

    async function searchM