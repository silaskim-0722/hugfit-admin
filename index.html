<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í—ˆê·¸í• ê´€ë¦¬ì ì¶œì„í˜ì´ì§€</title>
  <style>
    body { font-family: 'Arial'; padding: 20px; background: #f6f8fa; }
    h2 { text-align: center; color: #333; }
    label, select, input { font-size: 16px; margin: 10px 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th { background-color: #f0f0f0; }
    .filter-area { margin-bottom: 20px; text-align: center; }
    .status { 
      padding: 5px 10px; 
      border-radius: 3px; 
      font-size: 12px; 
      font-weight: bold; 
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .loading { background: #d1ecf1; color: #0c5460; }
    .info { background: #d1ecf1; color: #0c5460; }
    button { 
      padding: 8px 16px; 
      margin: 5px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px; 
    }
    button:hover { opacity: 0.8; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-danger { background: #dc3545; color: white; }
    #statusMessage { margin: 10px 0; padding: 10px; border-radius: 4px; }
    .google-sheets-info { 
      margin: 20px 0; 
      padding: 15px; 
      background: #e7f3ff; 
      border-radius: 5px; 
      border-left: 4px solid #007bff;
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .sync-status {
      text-align: center;
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>í—ˆê·¸í• ê´€ë¦¬ì ì¶œì„ í˜ì´ì§€</h2>

  <div class="google-sheets-info">
    <h3>ğŸ“Š êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ë²„ì „</h3>
    <p>ëª¨ë“  ë°ì´í„°ëŠ” êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ì €ì¥ë˜ë©°, ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë™ì‹œì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <p><strong>ë§ˆì§€ë§‰ ë™ê¸°í™”:</strong> <span id="lastSync">-</span></p>
    <button class="btn-info" onclick="refreshData()">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <div id="statusMessage" style="display: none;"></div>

  <div class="filter-area">
    <label for="search">ê³ ê° ì´ë¦„ ê²€ìƒ‰:</label>
    <input type="text" id="search" placeholder="ì˜ˆ: ê¹€ë¯¼ì •">
    <button class="btn-info" onclick="searchMember()">ê²€ìƒ‰</button>

    <br><br>
    <label>ë“±ë¡ ìœ í˜•:</label>
    <select id="regType" onchange="toggleOptions()">
      <option value="ì¿ í°">ì¿ í°</option>
      <option value="ê¸°ê°„">ê¸°ê°„</option>
    </select>

    <span id="couponOptions">
      <select id="couponSelect">
        <option value="10íšŒ_1ê°œì›”">í•œë‹¬ 10íšŒ</option>
        <option value="30íšŒ_3ê°œì›”">30íšŒ 3ê°œì›”</option>
        <option value="custom">ì§ì ‘ì…ë ¥</option>
      </select>
      <input type="number" id="customCount" placeholder="íšŸìˆ˜" style="display: none; width: 80px;">
    </span>

    <span id="periodOptions" style="display: none;">
      <select id="periodSelect">
        <option value="1ê°œì›”">1ê°œì›”</option>
        <option value="3ê°œì›”">3ê°œì›”</option>
        <option value="6ê°œì›”">6ê°œì›”</option>
        <option value="custom">ì§ì ‘ì…ë ¥</option>
      </select>
      <input type="number" id="customPeriod" placeholder="ê°œì›”" style="display: none; width: 80px;">
    </span>

    <button class="btn-primary" onclick="registerCustomer()" id="registerBtn">ê³ ê° ë“±ë¡</button>
    <button class="btn-success" onclick="markVisit()" id="visitBtn">ì¶œì„ ì²˜ë¦¬</button>
    <button class="btn-info" onclick="loadAllMembers()" id="loadAllBtn">ì „ì²´ íšŒì› ì¡°íšŒ</button>
    <button class="btn-success" onclick="loadTodayVisitors()" id="todayBtn">ì˜¤ëŠ˜ ì¶œì„ì</button>
  </div>

  <div class="sync-status" id="syncStatus" style="display: none;"></div>

  <table>
    <thead>
      <tr>
        <th>ê³ ê°ëª…</th>
        <th>ë“±ë¡ì¼ì</th>
        <th>ìµœê·¼ë°©ë¬¸ì¼</th>
        <th>ë‚¨ì€íšŸìˆ˜/ê¸°ê°„</th>
        <th>ìƒíƒœ</th>
        <th>ê´€ë¦¬</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>

  <script>
    // API URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbw3UXzSQbI6jIIVEbUYMCaHKQS4izqki9kJXO5oOORcKyid6tpofsFKtsE9K433IN2Ulw/exec';
    
    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showStatus(message, type = 'info', showSpinner = false) {
      const statusDiv = document.getElementById('statusMessage');
      const spinnerHtml = showSpinner ? '<div class="loading-spinner"></div>' : '';
      statusDiv.innerHTML = spinnerHtml + message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      if (!showSpinner) {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }

    // ë™ê¸°í™” ìƒíƒœ í‘œì‹œ
    function showSyncStatus(message, type = 'info') {
      const syncDiv = document.getElementById('syncStatus');
      syncDiv.textContent = message;
      syncDiv.className = `sync-status ${type}`;
      syncDiv.style.display = 'block';
      
      setTimeout(() => {
        syncDiv.style.display = 'none';
      }, 2000);
    }

    // ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateLastSync() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('ko-KR');
      document.getElementById('lastSync').textContent = timeString;
    }

    // API í˜¸ì¶œ í•¨ìˆ˜
    async function callAPI(action, data = {}) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: action,
          ...data
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      return await response.json();
    }

    // ë²„íŠ¼ ìƒíƒœ ì œì–´
    function setButtonsEnabled(enabled) {
      const buttons = ['registerBtn', 'visitBtn', 'loadAllBtn', 'todayBtn'];
      buttons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.disabled = !enabled;
        }
      });
    }

    function toggleOptions() {
      const type = document.getElementById("regType").value;
      document.getElementById("couponOptions").style.display = type === 'ì¿ í°' ? 'inline' : 'none';
      document.getElementById("periodOptions").style.display = type === 'ê¸°ê°„' ? 'inline' : 'none';
      
      // ì»¤ìŠ¤í…€ ì…ë ¥ í•„ë“œ í† ê¸€
      toggleCustomInput();
    }

    function toggleCustomInput() {
      const regType = document.getElementById("regType").value;
      
      if (regType === 'ì¿ í°') {
        const couponValue = document.getElementById("couponSelect").value;
        document.getElementById("customCount").style.display = couponValue === 'custom' ? 'inline' : 'none';
      } else {
        const periodValue = document.getElementById("periodSelect").value;
        document.getElementById("customPeriod").style.display = periodValue === 'custom' ? 'inline' : 'none';
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.getElementById("couponSelect").addEventListener("change", toggleCustomInput);
    document.getElementById("periodSelect").addEventListener("change", toggleCustomInput);

    async function registerCustomer() {
      const name = prompt("ë“±ë¡í•  ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
      if (!name || !name.trim()) return;
      
      const trimmedName = name.trim();
      
      setButtonsEnabled(false);
      showStatus("ê³ ê° ë“±ë¡ ì¤‘...", "loading", true);
      
      try {
        const regType = document.getElementById("regType").value;
        let memberData = {
          name: trimmedName,
          type: regType
        };

        if (regType === 'ì¿ í°') {
          const couponValue = document.getElementById("couponSelect").value;
          let count;
          
          if (couponValue === 'custom') {
            count = parseInt(document.getElementById("customCount").value);
            if (!count || count <= 0) {
              showStatus("ì˜¬ë°”ë¥¸ íšŸìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
              return;
            }
          } else {
            count = parseInt(couponValue.split("íšŒ")[0]);
          }
          
          memberData.count = count;
        } else {
          const periodValue = document.getElementById("periodSelect").value;
          let months;
          
          if (periodValue === 'custom') {
            months = parseInt(document.getElementById("customPeriod").value);
            if (!months || months <= 0) {
              showStatus("ì˜¬ë°”ë¥¸ ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
              return;
            }
          } else {
            months = parseInt(periodValue.replace("ê°œì›”", ''));
          }
          
          memberData.months = months;
        }

        const result = await callAPI('registerMember', memberData);
        
        if (result.success) {
          showStatus(`${trimmedName} ê³ ê° ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
          showSyncStatus("âœ… êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë¨", "success");
          updateLastSync();
          
          // ë“±ë¡ í›„ ìë™ ê²€ìƒ‰
          document.getElementById("search").value = trimmedName;
          setTimeout(() => searchMember(), 500);
        } else {
          showStatus(`ë“±ë¡ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, "error");
        }
        
      } catch (error) {
        console.error('ë“±ë¡ ì‹¤íŒ¨:', error);
        showStatus("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
      } finally {
        setButtonsEnabled(true);
      }
    }

    async function searchM