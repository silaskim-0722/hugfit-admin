<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>허그핏 관리자 출석페이지</title>
  <style>
    body { font-family: 'Arial'; padding: 20px; background: #f6f8fa; }
    h2 { text-align: center; color: #333; }
    label, select, input { font-size: 16px; margin: 10px 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th { background-color: #f0f0f0; }
    .filter-area { margin-bottom: 20px; text-align: center; }

    .status { 
      padding: 5px 10px; 
      border-radius: 3px; 
      font-size: 12px; 
      font-weight: bold; 
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .loading { background: #d1ecf1; color: #0c5460; }

    button { 
      padding: 8px 16px; 
      margin: 5px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px; 
    }
    button:hover { opacity: 0.8; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-info { background: #17a2b8; color: white; }

    #statusMessage { margin: 10px 0; padding: 10px; border-radius: 4px; }
  </style>
</head>
<body>

  <h2>허그핏 관리자 출석 페이지</h2>
  <div id="statusMessage" style="display:none;"></div>

  <div class="filter-area">

    <label for="search">고객 이름 검색:</label>
    <input type="text" id="search" placeholder="예: 김민정">
    <button class="btn-info" onclick="searchMember()">검색</button>

    <br><br>

    <label>등록 유형:</label>
    <select id="regType" onchange="toggleOptions()">
      <option value="쿠폰">쿠폰</option>
      <option value="기간">기간</option>
    </select>

    <span id="couponOptions">
      <select id="couponSelect">
        <option value="10회_1개월">한달 10회</option>
        <option value="30회_3개월">30회 3개월</option>
      </select>
    </span>

    <span id="periodOptions" style="display:none;">
      <select id="periodSelect">
        <option value="1개월">1개월</option>
        <option value="3개월">3개월</option>
      </select>
    </span>

    <button class="btn-primary" onclick="registerCustomer()">고객 등록</button>
    <button class="btn-success" onclick="markVisit()">출석 처리</button>
    <button class="btn-info" onclick="loadAllMembers()">전체 회원 조회</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>고객명</th>
        <th>등록일자</th>
        <th>최근 방문일</th>
        <th>남은 횟수/기간</th>
        <th>상태</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>

<script>

  // ⭐ 변경된 Google Web App URL
  const SHEET_URL =
    "https://script.google.com/macros/s/AKfycbxsa0wxqGaMwyz0QPrecdagFJid2VUxSuvKYRf67LP-zqrgiWtJECSxN-DYfErmI5dyOg/exec";

  function showStatus(message, type = 'info') {
    const el = document.getElementById("statusMessage");
    el.textContent = message;
    el.className = "status " + type;
    el.style.display = "block";
    setTimeout(() => el.style.display = "none", 3000);
  }

  function toggleOptions() {
    const type = document.getElementById("regType").value;
    document.getElementById("couponOptions").style.display = (type === "쿠폰") ? "inline" : "none";
    document.getElementById("periodOptions").style.display = (type === "기간") ? "inline" : "none";
  }

  async function registerCustomer() {
    const name = prompt("등록할 고객명을 입력해주세요:");
    if (!name) return;

    showStatus("고객 등록 중...", "loading");

    const now = new Date();
    const regType = document.getElementById("regType").value;

    let info = {
      name,
      regDate: now.toISOString().split("T")[0],
      lastVisit: "",
      type: regType,
      action: "register"
    };

    if (regType === "쿠폰") {
      const val = document.getElementById("couponSelect").value;
      info.count = parseInt(val.split("회")[0]);
      info.status = `${info.count}회`;
    } else {
      const months = parseInt(document.getElementById("periodSelect").value.replace("개월",""));
      const expire = new Date(now.getTime() + months * 30 * 24 * 60 * 60 * 1000);
      info.expire = expire.toISOString().split("T")[0];
      info.status = `~ ${info.expire}`;
    }

    // local 저장
    localStorage.setItem(`member_${name}`, JSON.stringify(info));

    // Google Sheet 전송
    await fetch(SHEET_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(info)
    });

    showStatus("등록 완료되었습니다.", "success");
    document.getElementById("search").value = name;
    searchMember();
  }

  function searchMember() {
    const name = document.getElementById("search").value.trim();
    const tbody = document.getElementById("resultBody");
    tbody.innerHTML = "";

    if (!name) return showStatus("고객명을 입력해주세요.", "warning");

    const data = localStorage.getItem(`member_${name}`);
    if (!data) return showStatus("등록된 고객이 없습니다.", "warning");

    displayMemberRow(JSON.parse(data));
  }

  function displayMemberRow(info) {
    const tbody = document.getElementById("resultBody");
    const row = document.createElement("tr");

    let statusText = "";
    let statusClass = "";

    if (info.type === "쿠폰") {
      statusText = info.count > 0 ? `${info.count}회 남음` : "사용완료";
      statusClass = info.count > 0 ? "success" : "error";
    } else {
      const today = new Date();
      const expireDate = new Date(info.expire);
      const diff = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
      statusText = diff >= 0 ? `${diff}일 남음` : "기간 만료";
      statusClass = diff >= 0 ? "success" : "error";
    }

    row.innerHTML = `
      <td>${info.name}</td>
      <td>${info.regDate}</td>
      <td>${info.lastVisit || "-"}</td>
      <td>${info.type === "쿠폰" ? info.count + "회" : "~ " + info.expire}</td>
      <td><span class="status ${statusClass}">${statusText}</span></td>
    `;
    tbody.appendChild(row);
  }

  async function markVisit() {
    const name = document.getElementById("search").value.trim();
    if (!name) return showStatus("고객명을 입력해주세요.", "warning");

    const key = `member_${name}`;
    const data = localStorage.getItem(key);
    if (!data) return showStatus("등록된 고객이 없습니다.", "warning");

    const info = JSON.parse(data);
    const today = new Date().toISOString().split("T")[0];

    // ⭐ 중복 출석 체크 방지
    if (info.lastVisit === today) {
      return showStatus("이미 오늘 출석 처리되었습니다.", "warning");
    }

    // 쿠폰 남은 횟수 확인
    if (info.type === "쿠폰" && info.count <= 0) {
      return showStatus("남은 횟수가 없습니다.", "error");
    }

    // 기간 만료 확인
    if (info.type === "기간") {
      if (new Date() > new Date(info.expire)) {
        return showStatus("기간이 만료되었습니다.", "error");
      }
    }

    showStatus("출석 반영 중...", "loading");

    info.lastVisit = today;

    if (info.type === "쿠폰") info.count--;

    // local 저장
    localStorage.setItem(key, JSON.stringify(info));

    // Google Sheets 업데이트
    await fetch(SHEET_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ...info,
        action: "visit",
        status: info.type === "쿠폰" ? `${info.count}회` : `~ ${info.expire}`
      })
    });

    showStatus("출석이 정상 처리되었습니다.", "success");
    searchMember();
  }

  function loadAllMembers() {
    const tbody = document.getElementById("resultBody");
    tbody.innerHTML = "";

    let found = false;

    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);

      if (key.startsWith("member_")) {
        displayMemberRow(JSON.parse(localStorage.getItem(key)));
        found = true;
      }
    }

    if (!found) showStatus("등록된 회원이 없습니다.", "warning");
    else showStatus("전체 목록 불러오기 완료되었습니다.", "success");
  }

  window.onload = () => showStatus("허그핏 관리자 페이지 로드 완료", "success");

</script>
</body>
</html>
