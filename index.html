<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í—ˆê·¸í• ê´€ë¦¬ì ì¶œì„í˜ì´ì§€</title>
  <style>
    body { font-family: 'Arial'; padding: 20px; background: #f6f8fa; }
    h2 { text-align: center; color: #333; }
    label, select, input { font-size: 16px; margin: 10px 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th { background-color: #f0f0f0; }
    .filter-area { margin-bottom: 20px; text-align: center; }
    .status { 
      padding: 5px 10px; 
      border-radius: 3px; 
      font-size: 12px; 
      font-weight: bold; 
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    .loading { background: #d1ecf1; color: #0c5460; }
    .info { background: #d1ecf1; color: #0c5460; }
    button { 
      padding: 8px 16px; 
      margin: 5px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px; 
    }
    button:hover { opacity: 0.8; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-danger { background: #dc3545; color: white; }
    #statusMessage { margin: 10px 0; padding: 10px; border-radius: 4px; }
    .google-sheets-info { 
      margin: 20px 0; 
      padding: 15px; 
      background: #e7f3ff; 
      border-radius: 5px; 
      border-left: 4px solid #007bff;
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .sync-status {
      text-align: center;
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>í—ˆê·¸í• ê´€ë¦¬ì ì¶œì„ í˜ì´ì§€</h2>

  <div class="google-sheets-info">
    <h3>ğŸ“Š êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ë²„ì „</h3>
    <p>ëª¨ë“  ë°ì´í„°ëŠ” êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ì €ì¥ë˜ë©°, ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë™ì‹œì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <p><strong>ë§ˆì§€ë§‰ ë™ê¸°í™”:</strong> <span id="lastSync">-</span></p>
    <button class="btn-info" onclick="refreshData()">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <div id="statusMessage" style="display: none;"></div>

  <div class="filter-area">
    <label for="search">ê³ ê° ì´ë¦„ ê²€ìƒ‰:</label>
    <input type="text" id="search" placeholder="ì˜ˆ: ê¹€ë¯¼ì •">
    <button class="btn-info" onclick="searchMember()">ê²€ìƒ‰</button>

    <br><br>
    <label>ë“±ë¡ ìœ í˜•:</label>
    <select id="regType" onchange="toggleOptions()">
      <option value="ì¿ í°">ì¿ í°</option>
      <option value="ê¸°ê°„">ê¸°ê°„</option>
    </select>

    <span id="couponOptions">
      <select id="couponSelect" onchange="toggleCustomInput()">
        <option value="10íšŒ_1ê°œì›”">í•œë‹¬ 10íšŒ</option>
        <option value="30íšŒ_3ê°œì›”">30íšŒ 3ê°œì›”</option>
        <option value="custom">ì§ì ‘ì…ë ¥</option>
      </select>
      <input type="number" id="customCount" placeholder="íšŸìˆ˜" style="display: none; width: 80px;">
    </span>

    <span id="periodOptions" style="display: none;">
      <select id="periodSelect" onchange="toggleCustomInput()">
        <option value="1ê°œì›”">1ê°œì›”</option>
        <option value="3ê°œì›”">3ê°œì›”</option>
        <option value="6ê°œì›”">6ê°œì›”</option>
        <option value="custom">ì§ì ‘ì…ë ¥</option>
      </select>
      <input type="number" id="customPeriod" placeholder="ê°œì›”" style="display: none; width: 80px;">
    </span>

    <button class="btn-primary" onclick="registerCustomer()" id="registerBtn">ê³ ê° ë“±ë¡</button>
    <button class="btn-success" onclick="markVisit()" id="visitBtn">ì¶œì„ ì²˜ë¦¬</button>
    <button class="btn-info" onclick="loadAllMembers()" id="loadAllBtn">ì „ì²´ íšŒì› ì¡°íšŒ</button>
    <button class="btn-success" onclick="loadTodayVisitors()" id="todayBtn">ì˜¤ëŠ˜ ì¶œì„ì</button>
  </div>

  <div class="sync-status" id="syncStatus" style="display: none;"></div>

  <table>
    <thead>
      <tr>
        <th>ê³ ê°ëª…</th>
        <th>ë“±ë¡ì¼ì</th>
        <th>ìµœê·¼ë°©ë¬¸ì¼</th>
        <th>ë‚¨ì€íšŸìˆ˜/ê¸°ê°„</th>
        <th>ìƒíƒœ</th>
        <th>ê´€ë¦¬</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    var API_URL = 'https://script.google.com/macros/s/AKfycbw3UXzSQbI6jIIVEbUYMCaHKQS4izqki9kJXO5oOORcKyid6tpofsFKtsE9K433IN2Ulw/exec';
    
    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showStatus(message, type, showSpinner) {
      var statusDiv = document.getElementById('statusMessage');
      var spinnerHtml = showSpinner ? '<div class="loading-spinner"></div>' : '';
      statusDiv.innerHTML = spinnerHtml + message;
      statusDiv.className = 'status ' + (type || 'info');
      statusDiv.style.display = 'block';
      
      if (!showSpinner) {
        setTimeout(function() {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }

    // ë™ê¸°í™” ìƒíƒœ í‘œì‹œ
    function showSyncStatus(message, type) {
      var syncDiv = document.getElementById('syncStatus');
      syncDiv.textContent = message;
      syncDiv.className = 'sync-status ' + (type || 'info');
      syncDiv.style.display = 'block';
      
      setTimeout(function() {
        syncDiv.style.display = 'none';
      }, 2000);
    }

    // ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateLastSync() {
      var now = new Date();
      var timeString = now.toLocaleTimeString('ko-KR');
      document.getElementById('lastSync').textContent = timeString;
    }

    // ë²„íŠ¼ ìƒíƒœ ì œì–´
    function setButtonsEnabled(enabled) {
      var buttons = ['registerBtn', 'visitBtn', 'loadAllBtn', 'todayBtn'];
      for (var i = 0; i < buttons.length; i++) {
        var btn = document.getElementById(buttons[i]);
        if (btn) {
          btn.disabled = !enabled;
        }
      }
    }

    function toggleOptions() {
      var type = document.getElementById("regType").value;
      document.getElementById("couponOptions").style.display = type === 'ì¿ í°' ? 'inline' : 'none';
      document.getElementById("periodOptions").style.display = type === 'ê¸°ê°„' ? 'inline' : 'none';
      toggleCustomInput();
    }

    function toggleCustomInput() {
      var regType = document.getElementById("regType").value;
      
      if (regType === 'ì¿ í°') {
        var couponValue = document.getElementById("couponSelect").value;
        document.getElementById("customCount").style.display = couponValue === 'custom' ? 'inline' : 'none';
      } else {
        var periodValue = document.getElementById("periodSelect").value;
        document.getElementById("customPeriod").style.display = periodValue === 'custom' ? 'inline' : 'none';
      }
    }

    function registerCustomer() {
      var name = prompt("ë“±ë¡í•  ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
      if (!name || !name.trim()) return;
      
      var trimmedName = name.trim();
      
      setButtonsEnabled(false);
      showStatus("ê³ ê° ë“±ë¡ ì¤‘...", "loading", true);
      
      var regType = document.getElementById("regType").value;
      var memberData = {
        action: 'registerMember',
        name: trimmedName,
        type: regType
      };

      if (regType === 'ì¿ í°') {
        var couponValue = document.getElementById("couponSelect").value;
        var count;
        
        if (couponValue === 'custom') {
          count = parseInt(document.getElementById("customCount").value);
          if (!count || count <= 0) {
            showStatus("ì˜¬ë°”ë¥¸ íšŸìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
            setButtonsEnabled(true);
            return;
          }
        } else {
          count = parseInt(couponValue.split("íšŒ")[0]);
        }
        
        memberData.count = count;
      } else {
        var periodValue = document.getElementById("periodSelect").value;
        var months;
        
        if (periodValue === 'custom') {
          months = parseInt(document.getElementById("customPeriod").value);
          if (!months || months <= 0) {
            showStatus("ì˜¬ë°”ë¥¸ ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
            setButtonsEnabled(true);
            return;
          }
        } else {
          months = parseInt(periodValue.replace("ê°œì›”", ''));
        }
        
        memberData.months = months;
      }

      // í¼ ë°ì´í„° ìƒì„±
      var formData = new FormData();
      for (var key in memberData) {
        formData.append(key, memberData[key]);
      }

      fetch(API_URL, {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(result) {
        if (result.success) {
          showStatus(trimmedName + " ê³ ê° ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
          showSyncStatus("âœ… êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë¨", "success");
          updateLastSync();
          
          // ë“±ë¡ í›„ ìë™ ê²€ìƒ‰
          document.getElementById("search").value = trimmedName;
          setTimeout(function() {
            searchMember();
          }, 500);
        } else {
          showStatus("ë“±ë¡ ì‹¤íŒ¨: " + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), "error");
        }
        setButtonsEnabled(true);
      })
      .catch(function(error) {
        console.error('ë“±ë¡ ì‹¤íŒ¨:', error);
        showStatus("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "error");
        setButtonsEnabled(true);
      });
    }

    function searchMember() {
      var name = document.getElementById('search').value.trim();
      if (!name) {
        showStatus("ê²€ìƒ‰í•  ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
        return;
      }

      setButtonsEnabled(false);
      showStatus("ê²€ìƒ‰ ì¤‘...", "loading", true);
      
      var formData = new FormData();
      formData.append('action', 'searchMember');
      formData.append('name', name);

      fetch(API_URL, {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(result) {
        if (result.success) {
          displayMembers(result.data);
          showStatus("\"" + name + "\" ê²€ìƒ‰ ê²°ê³¼: " + result.data.length + "ëª…", "success");
          updateLastSync();
        } else {
          showStatus("ê²€ìƒ‰ ì‹¤íŒ¨: " + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), "error");
        }
        setButtonsEnabled(true);
      })
      .catch(function(error) {
        console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
        showStatus("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        setButtonsEnabled(true);
      });
    }

    function markVisit() {
      var name = prompt("ì¶œì„ ì²˜ë¦¬í•  ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
      if (!name || !name.trim()) return;
      
      var trimmedName = name.trim();
      
      setButtonsEnabled(false);
      showStatus("ì¶œì„ ì²˜ë¦¬ ì¤‘...", "loading", true);
      
      var formData = new FormData();
      formData.append('action', 'markVisit');
      formData.append('name', trimmedName);

      fetch(API_URL, {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(result) {
        if (result.success) {
          showStatus(trimmedName + " ê³ ê°ì˜ ì¶œì„ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
          showSyncStatus("âœ… êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë¨", "success");
          updateLastSync();
          
          // ì¶œì„ ì²˜ë¦¬ í›„ ìë™ ê²€ìƒ‰
          document.getElementById("search").value = trimmedName;
          setTimeout(function() {
            searchMember();
          }, 500);
        } else {
          showStatus("ì¶œì„ ì²˜ë¦¬ ì‹¤íŒ¨: " + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), "error");
        }
        setButtonsEnabled(true);
      })
      .catch(function(error) {
        console.error('ì¶œì„ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        showStatus("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        setButtonsEnabled(true);
      });
    }

    function loadAllMembers() {
      setButtonsEnabled(false);
      showStatus("ì „ì²´ íšŒì› ì¡°íšŒ ì¤‘...", "loading", true);
      
      var formData = new FormData();
      formData.append('action', 'getAllMembers');

      fetch(API_URL, {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(result) {
        if (result.success) {
          displayMembers(result.data);
          showStatus("ì „ì²´ íšŒì›: " + result.data.length + "ëª…", "success");
          updateLastSync();
        } else {
          showStatus("ì¡°íšŒ ì‹¤íŒ¨: " + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), "error");
        }
        setButtonsEnabled(true);
      })
      .catch(function(error) {
        console.error('ì „ì²´ íšŒì› ì¡°íšŒ ì‹¤íŒ¨:', error);
        showStatus("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        setButtonsEnabled(true);
      });
    }

    function loadTodayVisitors() {
      setButtonsEnabled(false);
      showStatus("ì˜¤ëŠ˜ ì¶œì„ì ì¡°íšŒ ì¤‘...", "loading", true);
      
      var formData = new FormData();
      formData.append('action', 'getTodayVisitors');

      fetch(API_URL, {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(result) {
        if (result.success) {
          displayMembers(result.data);
          showStatus("ì˜¤ëŠ˜ ì¶œì„ì: " + result.data.length + "ëª…", "success");
          updateLastSync();
        } else {
          showStatus("ì¡°íšŒ ì‹¤íŒ¨: " + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), "error");
        }
        setButtonsEnabled(true);
      })
      .catch(function(error) {
        console.error('ì˜¤ëŠ˜ ì¶œì„ì ì¡°íšŒ ì‹¤íŒ¨:', error);
        showStatus("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        setButtonsEnabled(true);
      });
    }

    function refreshData() {
      showStatus("ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì¤‘...", "loading", true);
      showSyncStatus("ğŸ”„ ë™ê¸°í™” ì¤‘...", "loading");
      
      var formData = new FormData();
      formData.append('action', 'refreshData');

      fetch(API_URL, {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(result) {
        if (result.success) {
          showStatus("ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ", "success");
          showSyncStatus("âœ… ë™ê¸°í™” ì™„ë£Œ", "success");
          updateLastSync();
        } else {
          showStatus("ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨", "error");
          showSyncStatus("âŒ ë™ê¸°í™” ì‹¤íŒ¨", "error");
        }
      })
      .catch(function(error) {
        console.error('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
        showStatus("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        showSyncStatus("âŒ ì—°ê²° ì˜¤ë¥˜", "error");
      });
    }

    function displayMembers(members) {
      var tbody = document.getElementById('resultBody');
      tbody.innerHTML = '';
      
      if (!members || members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      for (var i = 0; i < members.length; i++) {
        var member = members[i];
        var row = document.createElement('tr');
        
        // ìƒíƒœ ê³„ì‚°
        var statusHtml = '';
        var remainingInfo = '';
        
        if (member.type === 'ì¿ í°') {
          remainingInfo = (member.remainingCount || 0) + 'íšŒ';
          if (member.remainingCount <= 0) {
            statusHtml = '<span class="status error">ë§Œë£Œ</span>';
          } else if (member.remainingCount <= 3) {
            statusHtml = '<span class="status warning">ì¢…ë£Œì„ë°•</span>';
          } else {
            statusHtml = '<span class="status success">ì •ìƒ</span>';
          }
        } else {
          var endDate = new Date(member.endDate);
          var today = new Date();
          var diffDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
          
          remainingInfo = diffDays + 'ì¼';
          if (diffDays <= 0) {
            statusHtml = '<span class="status error">ë§Œë£Œ</span>';
          } else if (diffDays <= 7) {
            statusHtml = '<span class="status warning">ì¢…ë£Œì„ë°•</span>';
          } else {
            statusHtml = '<span class="status success">ì •ìƒ</span>';
          }
        }

        row.innerHTML = 
          '<td>' + member.name + '</td>' +
          '<td>' + (member.registrationDate || '-') + '</td>' +
          '<td>' + (member.lastVisit || '-') + '</td>' +
          '<td>' + remainingInfo + '</td>' +
          '<td>' + statusHtml + '</td>' +
          '<td>' +
            '<button class="btn-success" onclick="quickVisit(\'' + member.name + '\')">ì¶œì„</button>' +
            '<button class="btn-warning" onclick="editMember(\'' + member.name + '\')">ìˆ˜ì •</button>' +
          '</td>';
        
        tbody.appendChild(row);
      }
    }

    function quickVisit(name) {
      if (!confirm(name + " ê³ ê°ì˜ ì¶œì„ì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      
      setButtonsEnabled(false);
      showStatus("ì¶œì„ ì²˜ë¦¬ ì¤‘...", "loading", true);
      
      var formData = new FormData();
      formData.append('action', 'markVisit');
      formData.append('name', name);

      fetch(API_URL, {
        method: 'POST',
        body: formData
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(result) {
        if (result.success) {
          showStatus(name + " ê³ ê°ì˜ ì¶œì„ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
          showSyncStatus("âœ… êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë¨", "success");
          updateLastSync();
          
          // í˜„ì¬ í™”ë©´ ìƒˆë¡œê³ ì¹¨
          var searchValue = document.getElementById('search').value;
          if (searchValue) {
            setTimeout(function() {
              searchMember();
            }, 500);
          } else {
            setTimeout(function() {
              loadAllMembers();
            }, 500);
          }
        } else {
          showStatus("ì¶œì„ ì²˜ë¦¬ ì‹¤íŒ¨: " + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), "error");
        }
        setButtonsEnabled(true);
      })
      .catch(function(error) {
        console.error('ì¶œì„ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        showStatus("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        setButtonsEnabled(true);
      });
    }

    function editMember(name) {
      showStatus("íšŒì› ìˆ˜ì • ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.", "info");
    }

    // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
    document.getElementById('search').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchMember();
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = function() {
      updateLastSync();
      showStatus("ê´€ë¦¬ì í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì™€ ì—°ë™ë©ë‹ˆë‹¤.", "info");
    };
  </script>
</body>
</html>